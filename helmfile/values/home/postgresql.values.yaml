fullnameOverride: postgresql
architecture: standalone

auth:
  username: airflow
  database: airflow_metadata

primary:
  persistence:
    enabled: true
    size: 10Gi
    storageClass: local-path
  nodeSelector:
    kubernetes.io/hostname: ampere-k8s-node1
  extraEnvVarsSecret: postgresql-extra-env
  initdb:
    scripts:
      01-create-ampere.sh: |
        #!/bin/bash
        set -e
        psql -v ON_ERROR_STOP=1 <<EOF
        DO $$
        BEGIN
          IF NOT EXISTS (SELECT FROM pg_roles WHERE rolname = '${AMPERE_DB_USER}') THEN
            CREATE ROLE ${AMPERE_DB_USER} LOGIN PASSWORD '${AMPERE_DB_PASSWORD}';
          END IF;
          IF NOT EXISTS (SELECT FROM pg_database WHERE datname = '${AMPERE_DB_NAME}') THEN
            CREATE DATABASE ${AMPERE_DB_NAME} OWNER ${AMPERE_DB_USER};
          END IF;
        END$$;
        EOF
  resources:
    requests:
      cpu: "250m"
      memory: "512Mi"
    limits:
      cpu: "1"
      memory: "1Gi"

volumePermissions:
  enabled: true

appUsers:
  ampere:
    user: ampere
    database: ampere

extraDeploy:
  - apiVersion: v1
    kind: Secret
    metadata:
      name: postgresql-extra-env
      namespace: {{ .Release.Namespace }}
    type: Opaque
    stringData:
      AIRFLOW_DB_USER: "{{ .Values.auth.username }}"
      AIRFLOW_DB_PASSWORD: "{{ .Values.auth.password }}"
      AIRFLOW_DB_NAME: "{{ .Values.auth.database }}"
      AMPERE_DB_USER: "{{ .Values.appUsers.ampere.user }}"
      AMPERE_DB_PASSWORD: "{{ .Values.appUsers.ampere.password }}"
      AMPERE_DB_NAME: "{{ .Values.appUsers.ampere.database }}"
