@startuml Workflow
!includeurl https://raw.githubusercontent.com/plantuml-stdlib/C4-PlantUML/master/C4_Component.puml
LAYOUT_WITH_LEGEND()
HIDE_STEREOTYPE()

System_Ext(keyvault, "Azure Key Vault", "KMS", "SOPS and ESO keys")
System_Ext(registry, "Container Registry", "Registry", "Service images")

Person(dev, "Developer", "Operates provisioning and service delivery")

Container_Boundary(provisioning, "Provisioning Pipeline") {
    Component(terraform, "Terraform", "CLI", "Renders templates and creates libvirt VMs")
    Component(tfMain, "Terraform libvirt main.tf", "IaC", "VM, network, and disk definitions")
    Component(tfTemplates, "Cloud-Init templates", "Templates", "cloud-init userdata and bootstrap scripts")
    Component(tfScripts, "Bootstrap scripts", "Scripts", "OS/kubeadm stages and readiness gates")
    Component(cloudinit, "Cloud-Init", "Bootstrap", "Configures networking and OS prerequisites")
    Component(kubeadm, "kubeadm", "Bootstrap", "Initializes control plane and joins workers")
    Component(cilium, "Cilium", "CNI", "Enables pod networking")
    Component(localpath, "local-path-provisioner", "StorageClass", "Provides default storage")
}

Container_Boundary(services, "Service Delivery") {
    Component(helmfile, "Helmfile", "CLI", "Applies releases and hooks")
    Component(certmanager, "cert-manager", "Chart", "Issues TLS certificates")
    Component(ingress, "ingress-nginx", "Chart", "Ingress controller for HTTP/S and TCP")
    Component(ingressResources, "Ingress resources", "Chart", "Ingress routes, TCP mappings, and local CA")
    Component(externalSecrets, "External Secrets Operator", "Chart", "Syncs Key Vault secrets")
    Component(externalSecretsResources, "External Secrets resources", "Chart", "SecretStore and ExternalSecret manifests")
    Component(monitoring, "kube-prometheus-stack", "Chart", "Prometheus + Grafana monitoring")
    Component(sparkOperator, "Spark Operator", "Chart", "SparkApplication controller")
    Component(airflowSparkRbac, "Airflow Spark RBAC", "Chart", "RBAC for SparkApplication creation")
    Component(ivyCache, "Ivy cache", "Chart", "PVC for Spark JAR dependencies")
    Component(postgres, "PostgreSQL", "Chart", "Metadata and operational databases")
    Component(minio, "MinIO", "Chart", "S3-compatible object storage")
    Component(airflow, "Airflow", "Chart", "Workflow orchestration")
    Component(keda, "KEDA", "Chart", "Autoscaling for workers")
}

Rel(dev, terraform, "Runs provisioning")
Rel(terraform, tfMain, "Applies")
Rel(terraform, tfTemplates, "Renders")
Rel(terraform, tfScripts, "Stages")
Rel(tfTemplates, cloudinit, "Generates userdata")
Rel(tfScripts, kubeadm, "Invokes bootstrap")
Rel(terraform, cloudinit, "Injects userdata")
Rel(cloudinit, kubeadm, "Installs and configures Kubernetes")
Rel(kubeadm, cilium, "Applies CNI")
Rel(kubeadm, localpath, "Applies storage class")
Rel(dev, helmfile, "Runs service deployment")
Rel(helmfile, certmanager, "Installs release")
Rel(helmfile, ingress, "Installs release")
Rel(helmfile, ingressResources, "Installs release")
Rel(helmfile, externalSecrets, "Installs release")
Rel(helmfile, externalSecretsResources, "Installs release")
Rel(externalSecrets, keyvault, "Reads secrets")
Rel(helmfile, monitoring, "Installs release")
Rel(helmfile, sparkOperator, "Installs release")
Rel(helmfile, airflowSparkRbac, "Installs release")
Rel(helmfile, ivyCache, "Installs release")
Rel(helmfile, postgres, "Installs release")
Rel(helmfile, minio, "Installs release")
Rel(helmfile, keda, "Installs release")
Rel(helmfile, airflow, "Installs release")
Rel(certmanager, ingressResources, "Issues certificates")
Rel(externalSecrets, externalSecretsResources, "Reconciles secrets")
Rel(ingressResources, ingress, "Configures routes")
Rel(airflow, postgres, "Uses metadata DB")
Rel(airflow, minio, "Reads/writes objects")
Rel(airflow, registry, "Pulls images")
Rel(keda, airflow, "Scales workers")

SHOW_LEGEND()
@enduml
